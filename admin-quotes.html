<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Quotes Inbox</title>

  <!-- Force root for all relative URLs -->
  <base href="/" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Montserrat:wght@500;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/styles.css?v=8" />
</head>
<body>
  <header class="site-header">
    <button id="menuToggle" class="hamburger" aria-label="Open menu" aria-expanded="false" aria-controls="siteNav">
      <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </button>
    <a class="brand" href="/#top" aria-label="GrillShine Home">
      <span class="brand-logo" aria-hidden="true"></span>
      <span class="brand-text">GrillShine</span>
    </a>
  </header>

  <nav id="siteNav" class="nav-drawer" aria-hidden="true">
    <div class="drawer-head">
      <span class="drawer-title">Menu</span>
      <button id="closeMenu" class="close-btn" aria-label="Close menu">✕</button>
    </div>
    <ul>
      <li><a href="/#top"      class="nav-link">Home</a></li>
      <li><a href="/#quote"    class="nav-link">Get a Quote</a></li>
      <li><a href="/#services" class="nav-link">Services</a></li>
      <li><a href="/about.html"          class="nav-link">About</a></li>
      <li><a href="/before-after.html"   class="nav-link">Before &amp; After</a></li>
      <li><a href="/faq.html"            class="nav-link">FAQ</a></li>
      <li><a href="/#contact"            class="nav-link">Contact</a></li>
      <li><a href="/admin.html"          class="nav-link">Admin</a></li>
    </ul>
    <div class="nav-cta">
      <a class="btn btn-outline" href="tel:+1-813-555-0199">Call: (813) 555-0199</a>
    </div>
  </nav>
  <div id="backdrop" class="backdrop" hidden></div>

  <section class="page-hero page-hero--sm">
    <div class="inner">
      <h1>Quotes Inbox</h1>
      <p class="sub">Review, export, and manage quote requests.</p>
    </div>
  </section>

  <main class="section">
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
      <input id="search" type="search" placeholder="Search name, email, phone…" class="btn" style="min-width:240px;background:#0f0f0f;border-color:rgba(255,209,102,.3);color:var(--ink)">
      <button id="refresh" class="btn btn-outline">Refresh</button>
      <button id="exportJson" class="btn btn-outline">Export JSON</button>
      <button id="exportCsv" class="btn btn-outline">Export CSV</button>
      <button id="signout" class="btn btn-ghost">Sign out</button>
    </div>

    <div id="meta" class="about-fineprint" style="margin-bottom:8px"></div>

    <div class="card" style="padding:0">
      <div style="overflow:auto">
        <table style="width:100%;border-collapse:collapse">
          <thead style="background:rgba(255,209,102,.06)">
            <tr>
              <th style="text-align:left;padding:12px;border-bottom:1px solid rgba(255,209,102,.18)">Date</th>
              <th style="text-align:left;padding:12px;border-bottom:1px solid rgba(255,209,102,.18)">Name</th>
              <th style="text-align:left;padding:12px;border-bottom:1px solid rgba(255,209,102,.18)">Phone</th>
              <th style="text-align:left;padding:12px;border-bottom:1px solid rgba(255,209,102,.18)">Email</th>
              <th style="text-align:left;padding:12px;border-bottom:1px solid rgba(255,209,102,.18)">Message</th>
              <th style="text-align:left;padding:12px;border-bottom:1px solid rgba(255,209,102,.18)">Files</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <small>© <span id="year"></span> GrillShine. All rights reserved.</small>
  </footer>

  <script src="/assets/script.js?v=14"></script>
  <script>
    (document.getElementById('year')||{}).textContent = new Date().getFullYear();

    // --- simple auth gate (same keys as admin.html)
    const LOCAL_KEYS  = ['gs_admin_signed_in','isAdminSignedIn'];
    const SESSION_KEY = 'gs_admin_logged_in';
    const isAuthed = () => {
      try {
        const local = LOCAL_KEYS.some(k => localStorage.getItem(k) === '1');
        const sess  = sessionStorage.getItem(SESSION_KEY) === '1';
        return local || sess;
      } catch (_) { return false; }
    };
    if (!isAuthed()) window.location.replace('/admin.html');

    // UI refs
    const rows   = document.getElementById('rows');
    const meta   = document.getElementById('meta');
    const search = document.getElementById('search');

    // fetch helpers (ALWAYS absolute paths)
    async function getJSON(url){
      const r = await fetch(url, {headers: {'Accept':'application/json'}});
      if (!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    function esc(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function render(list){
      const q = (search.value||'').toLowerCase();
      const filtered = list.filter(x => {
        const blob = [x.name,x.email,x.phone,x.details,x.zip].join(' ').toLowerCase();
        return !q || blob.includes(q);
      });

      rows.innerHTML = filtered.map(x => {
        const when = new Date(x.created_at || x.createdAt || x.date || '').toLocaleString();
        const files = (x.files||[]).map(f => `<a href="${esc(f.url||f.href)}" target="_blank" rel="noopener">${esc(f.filename||'file')}</a>`).join('<br>');
        return `<tr>
          <td style="padding:10px;border-bottom:1px solid rgba(255,209,102,.12)">${esc(when)}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,209,102,.12)">${esc(x.name)}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,209,102,.12)">${esc(x.phone)}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,209,102,.12)"><a href="mailto:${esc(x.email)}">${esc(x.email)}</a></td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,209,102,.12)">${esc(x.details)}</td>
          <td style="padding:10px;border-bottom:1px solid rgba(255,209,102,.12)">${files||''}</td>
        </tr>`;
      }).join('');

      meta.textContent = `${list.length} total • ${filtered.length} shown`;
    }

    async function load(){
      try {
        const data = await getJSON('/api/quotes'); // <— absolute
        render(data || []);
      } catch (e) {
        meta.textContent = 'Failed to load quotes.';
      }
    }

    document.getElementById('refresh').onclick = load;
    document.getElementById('exportJson').onclick = () => window.location.href = '/api/quotes/export.json';
    document.getElementById('exportCsv').onclick  = () => window.location.href = '/api/quotes/export.csv';
    document.getElementById('signout').onclick    = () => {
      try {
        ['gs_admin_logged_in','gs_admin_signed_in','isAdminSignedIn'].forEach(k => {
          sessionStorage.removeItem(k); localStorage.removeItem(k);
        });
      } finally {
        window.location.replace('/admin.html');
      }
    };
    search.addEventListener('input', () => load());

    load();
  </script>
</body>
</html>
